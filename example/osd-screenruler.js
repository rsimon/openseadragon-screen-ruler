(function(w,y){typeof exports=="object"&&typeof module<"u"?y(exports,require("openseadragon")):typeof define=="function"&&define.amd?define(["exports","openseadragon"],y):(w=typeof globalThis<"u"?globalThis:w||self,y(w.OSDScreenRuler={},w.OpenSeadragon))})(this,function(w,y){"use strict";var Je=Object.defineProperty;var Ke=(w,y,b)=>y in w?Je(w,y,{enumerable:!0,configurable:!0,writable:!0,value:b}):w[y]=b;var ie=(w,y,b)=>(Ke(w,typeof y!="symbol"?y+"":y,b),b);function b(){}function L(e,t){for(const n in t)e[n]=t[n];return e}function le(e){return e()}function se(){return Object.create(null)}function N(e){e.forEach(le)}function re(e){return typeof e=="function"}function Z(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function pe(e){return Object.keys(e).length===0}function oe(e){const t={};for(const n in e)n[0]!=="$"&&(t[n]=e[n]);return t}function X(e,t){const n={};t=new Set(t);for(const i in e)!t.has(i)&&i[0]!=="$"&&(n[i]=e[i]);return n}function A(e,t){e.appendChild(t)}function O(e,t,n){e.insertBefore(t,n||null)}function z(e){e.parentNode&&e.parentNode.removeChild(e)}function E(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function ve(e){return document.createTextNode(e)}function we(){return ve("")}function Y(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function c(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function be(e){return Array.from(e.childNodes)}function Se(e,t,{bubbles:n=!1,cancelable:i=!1}={}){return new CustomEvent(e,{detail:t,bubbles:n,cancelable:i})}let D;function B(e){D=e}function ae(){if(!D)throw new Error("Function called outside component initialization");return D}function Pe(e){ae().$$.on_mount.push(e)}function Ee(){const e=ae();return(t,n,{cancelable:i=!1}={})=>{const r=e.$$.callbacks[t];if(r){const o=Se(t,n,{cancelable:i});return r.slice().forEach(a=>{a.call(e,o)}),!o.defaultPrevented}return!0}}function ke(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(i=>i.call(this,t))}const F=[],fe=[];let R=[];const ue=[],Ie=Promise.resolve();let G=!1;function Me(){G||(G=!0,Ie.then(ce))}function J(e){R.push(e)}const K=new Set;let T=0;function ce(){if(T!==0)return;const e=D;do{try{for(;T<F.length;){const t=F[T];T++,B(t),Ce(t.$$)}}catch(t){throw F.length=0,T=0,t}for(B(null),F.length=0,T=0;fe.length;)fe.pop()();for(let t=0;t<R.length;t+=1){const n=R[t];K.has(n)||(K.add(n),n())}R.length=0}while(F.length);for(;ue.length;)ue.pop()();G=!1,K.clear(),B(e)}function Ce(e){if(e.fragment!==null){e.update(),N(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(J)}}function ze(e){const t=[],n=[];R.forEach(i=>e.indexOf(i)===-1?t.push(i):n.push(i)),n.forEach(i=>i()),R=t}const U=new Set;let V;function de(){V={r:0,c:[],p:V}}function ge(){V.r||N(V.c),V=V.p}function k(e,t){e&&e.i&&(U.delete(e),e.i(t))}function j(e,t,n,i){if(e&&e.o){if(U.has(e))return;U.add(e),V.c.push(()=>{U.delete(e),i&&(n&&e.d(1),i())}),e.o(t)}else i&&i()}function Q(e){e&&e.c()}function q(e,t,n){const{fragment:i,after_update:r}=e.$$;i&&i.m(t,n),J(()=>{const o=e.$$.on_mount.map(le).filter(re);e.$$.on_destroy?e.$$.on_destroy.push(...o):N(o),e.$$.on_mount=[]}),r.forEach(J)}function W(e,t){const n=e.$$;n.fragment!==null&&(ze(n.after_update),N(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Ve(e,t){e.$$.dirty[0]===-1&&(F.push(e),Me(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function $(e,t,n,i,r,o,a=null,f=[-1]){const l=D;B(e);const u=e.$$={fragment:null,ctx:[],props:o,update:b,not_equal:r,bound:se(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:se(),dirty:f,skip_bound:!1,root:t.target||l.$$.root};a&&a(u.root);let _=!1;if(u.ctx=n?n(e,t.props||{},(d,s,...h)=>{const p=h.length?h[0]:s;return u.ctx&&r(u.ctx[d],u.ctx[d]=p)&&(!u.skip_bound&&u.bound[d]&&u.bound[d](p),_&&Ve(e,d)),s}):[],u.update(),_=!0,N(u.before_update),u.fragment=i?i(u.ctx):!1,t.target){if(t.hydrate){const d=be(t.target);u.fragment&&u.fragment.l(d),d.forEach(z)}else u.fragment&&u.fragment.c();t.intro&&k(e.$$.fragment),q(e,t.target,t.anchor),ce()}B(l)}class x{constructor(){ie(this,"$$");ie(this,"$$set")}$destroy(){W(this,1),this.$destroy=b}$on(t,n){if(!re(n))return b;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(n),()=>{const r=i.indexOf(n);r!==-1&&i.splice(r,1)}}$set(t){this.$$set&&!pe(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const je="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(je);const Qe="";function He(e){let t,n,i,r,o,a,f;return{c(){t=E("g"),n=E("path"),r=E("path"),c(n,"d",i=`M${e[0]-e[4]} ${e[1]-1.5*e[3]} l${e[4]} ${-e[3]} l${e[4]} ${e[3]}`),c(n,"class","svelte-zrisge"),c(r,"d",o=`M${e[0]-e[4]} ${e[1]+1.5*e[3]} l${e[4]} ${e[3]} l${e[4]} ${-e[3]}`),c(r,"class","svelte-zrisge"),c(t,"class",a=e[5].class),c(t,"transform",f=`rotate(${e[2]}, ${e[0]}, ${e[1]})`)},m(l,u){O(l,t,u),A(t,n),A(t,r)},p(l,[u]){u&27&&i!==(i=`M${l[0]-l[4]} ${l[1]-1.5*l[3]} l${l[4]} ${-l[3]} l${l[4]} ${l[3]}`)&&c(n,"d",i),u&27&&o!==(o=`M${l[0]-l[4]} ${l[1]+1.5*l[3]} l${l[4]} ${l[3]} l${l[4]} ${-l[3]}`)&&c(r,"d",o),u&32&&a!==(a=l[5].class)&&c(t,"class",a),u&7&&f!==(f=`rotate(${l[2]}, ${l[0]}, ${l[1]})`)&&c(t,"transform",f)},i:b,o:b,d(l){l&&z(t)}}}function Ne(e,t,n){let i,r,o;const a=["x","y","scale","slant"];let f=X(t,a),{x:l}=t,{y:u}=t,{scale:_}=t,{slant:d}=t;return e.$$set=s=>{t=L(L({},t),oe(s)),n(5,f=X(t,a)),"x"in s&&n(0,l=s.x),"y"in s&&n(1,u=s.y),"scale"in s&&n(6,_=s.scale),"slant"in s&&n(7,d=s.slant)},e.$$.update=()=>{e.$$.dirty&64&&n(4,i=7/_),e.$$.dirty&64&&n(3,r=4/_),e.$$.dirty&128&&n(2,o=180*Math.atan(d)/Math.PI)},[l,u,o,r,i,f,_,d]}class Oe extends x{constructor(t){super(),$(this,t,Ne,He,Z,{x:0,y:1,scale:6,slant:7})}}const $e="";function Fe(e){let t,n,i,r,o,a;return{c(){t=E("g"),n=E("circle"),i=E("circle"),c(n,"class","slant-handle-outer svelte-12mn6zh"),c(n,"cx",e[0]),c(n,"cy",e[1]),c(n,"r",e[3]),c(i,"class","slant-handle-inner svelte-12mn6zh"),c(i,"cx",e[0]),c(i,"cy",e[1]),c(i,"r",e[2]),c(t,"class",r=e[4].class)},m(f,l){O(f,t,l),A(t,n),A(t,i),o||(a=Y(n,"pointerdown",e[6]),o=!0)},p(f,[l]){l&1&&c(n,"cx",f[0]),l&2&&c(n,"cy",f[1]),l&8&&c(n,"r",f[3]),l&1&&c(i,"cx",f[0]),l&2&&c(i,"cy",f[1]),l&4&&c(i,"r",f[2]),l&16&&r!==(r=f[4].class)&&c(t,"class",r)},i:b,o:b,d(f){f&&z(t),o=!1,a()}}}function Re(e,t,n){let i,r;const o=["x","y","scale"];let a=X(t,o),{x:f}=t,{y:l}=t,{scale:u}=t;function _(d){ke.call(this,e,d)}return e.$$set=d=>{t=L(L({},t),oe(d)),n(4,a=X(t,o)),"x"in d&&n(0,f=d.x),"y"in d&&n(1,l=d.y),"scale"in d&&n(5,u=d.scale)},e.$$.update=()=>{e.$$.dirty&32&&n(3,i=20/u),e.$$.dirty&32&&n(2,r=6/u)},[f,l,r,i,a,u,_]}class he extends x{constructor(t){super(),$(this,t,Re,Fe,Z,{x:0,y:1,scale:5})}}const xe="";function ee(e){const t=e.slice(),n=t[3]*t[2].width+t[4];return t[19]=n,t}function _e(e){let t,n,i,r,o,a=e[2]&&me(ee(e));return{c(){t=E("svg"),n=E("g"),a&&a.c(),c(n,"class","osd-screenruler svelte-1vl8agx"),c(n,"transform",e[5]),c(t,"class","svelte-1vl8agx")},m(f,l){O(f,t,l),A(t,n),a&&a.m(n,null),i=!0,r||(o=Y(n,"pointermove",e[9]),r=!0)},p(f,l){f[2]?a?(a.p(ee(f),l),l&4&&k(a,1)):(a=me(ee(f)),a.c(),k(a,1),a.m(n,null)):a&&(de(),j(a,1,1,()=>{a=null}),ge()),(!i||l&32)&&c(n,"transform",f[5])},i(f){i||(k(a),i=!0)},o(f){j(a),i=!1},d(f){f&&z(t),a&&a.d(),r=!1,o()}}}function me(e){let t,n,i,r,o,a,f,l,u,_,d;return a=new he({props:{class:"hideable",x:e[6].left,y:e[3]*e[6].left+e[4],scale:e[1]}}),a.$on("pointerdown",e[8]("left-slant")),f=new Oe({props:{class:"hideable",x:e[6].middle,y:e[3]*e[6].middle+e[4],scale:e[1],slant:e[3]}}),l=new he({props:{class:"hideable",x:e[6].right,y:e[3]*e[6].right+e[4],scale:e[1]}}),l.$on("pointerdown",e[8]("right-slant")),{c(){t=E("line"),r=E("polygon"),Q(a.$$.fragment),Q(f.$$.fragment),Q(l.$$.fragment),c(t,"class","ruler svelte-1vl8agx"),c(t,"x1",0),c(t,"y1",e[4]),c(t,"x2",n=e[2].width),c(t,"y2",i=e[19]),c(r,"class","h-pos-handle hideable svelte-1vl8agx"),c(r,"points",o=[[0,e[4]-e[7]/2],[e[2].width,e[19]-e[7]/2],[e[2].width,e[19]+e[7]/2],[0,e[4]+e[7]/2]].map(ye).join(" "))},m(s,h){O(s,t,h),O(s,r,h),q(a,s,h),q(f,s,h),q(l,s,h),u=!0,_||(d=[Y(t,"pointerdown",e[8]("ruler")),Y(r,"pointerdown",e[8]("ruler"))],_=!0)},p(s,h){(!u||h&16)&&c(t,"y1",s[4]),(!u||h&4&&n!==(n=s[2].width))&&c(t,"x2",n),(!u||h&28&&i!==(i=s[19]))&&c(t,"y2",i),(!u||h&156&&o!==(o=[[0,s[4]-s[7]/2],[s[2].width,s[19]-s[7]/2],[s[2].width,s[19]+s[7]/2],[0,s[4]+s[7]/2]].map(ye).join(" ")))&&c(r,"points",o);const p={};h&64&&(p.x=s[6].left),h&88&&(p.y=s[3]*s[6].left+s[4]),h&2&&(p.scale=s[1]),a.$set(p);const m={};h&64&&(m.x=s[6].middle),h&88&&(m.y=s[3]*s[6].middle+s[4]),h&2&&(m.scale=s[1]),h&8&&(m.slant=s[3]),f.$set(m);const M={};h&64&&(M.x=s[6].right),h&88&&(M.y=s[3]*s[6].right+s[4]),h&2&&(M.scale=s[1]),l.$set(M)},i(s){u||(k(a.$$.fragment,s),k(f.$$.fragment,s),k(l.$$.fragment,s),u=!0)},o(s){j(a.$$.fragment,s),j(f.$$.fragment,s),j(l.$$.fragment,s),u=!1},d(s){s&&(z(t),z(r)),W(a,s),W(f,s),W(l,s),_=!1,N(d)}}}function Te(e){let t,n,i=e[0]&&_e(e);return{c(){i&&i.c(),t=we()},m(r,o){i&&i.m(r,o),O(r,t,o),n=!0},p(r,[o]){r[0]?i?(i.p(r,o),o&1&&k(i,1)):(i=_e(r),i.c(),k(i,1),i.m(t.parentNode,t)):i&&(de(),j(i,1,1,()=>{i=null}),ge())},i(r){n||(k(i),n=!0)},o(r){j(i),n=!1},d(r){r&&z(t),i&&i.d(r)}}}const ye=e=>e.join(",");function Ae(e,t,n){let i;const r=Ee();let{viewer:o}=t,{handlePadding:a=8}=t,{visible:f}=t,{initialSlope:l}=t,u,_=l,d,s=1,h,p,m;const M=()=>{var v,S;const g=(S=(v=o.world.getItemAt(0))==null?void 0:v.source)==null?void 0:S.dimensions;g&&(n(2,u={width:g.x,height:g.y}),n(4,d=g.y/2),te())},te=()=>{const g=o.viewport.getContainerSize().x,v=o.viewport.getZoom(!0),S=o.viewport.getFlip(),C=o.viewport.pixelFromPoint(new y.Point(0,0),!0);S&&(C.x=g-C.x);const P=v*g/o.world.getContentFactor(),I=S?-P:P,H=o.viewport.getRotation(!0);n(5,h=`translate(${C.x}, ${C.y}) scale(${I}, ${P}) rotate(${H})`),n(1,s=v*g/o.world.getContentFactor()),qe()},qe=()=>{const{viewport:g}=o,v=g.viewportToImageRectangle(g.getBounds(!0)),{x:S,width:C}=v,P=Math.max(0,S+a/s),I=Math.min(u.width,S+C-a/s),H=P+(I-P)/2;n(6,m={left:P,middle:H,right:I})},We=g=>v=>{if(v.button!==0)return;p=g,v.target.setPointerCapture(v.pointerId),o.setMouseNavEnabled(!1)},Ze=g=>{if(!p)return;const{offsetX:v,offsetY:S}=g,{x:C,y:P}=o.viewport.viewerElementToImageCoordinates(new y.Point(v,S));if(p==="ruler")n(4,d=P-_*C);else if(p==="left-slant"){const I=_*m.right+d,H=m.right-m.left,ne=P-I;n(3,_=-ne/H),n(4,d=I-_*m.right),r("changeSlope",_)}else if(p==="right-slant"){const I=_*m.left+d,H=m.right-m.left,ne=I-P;n(3,_=-ne/H),n(4,d=I-_*m.left),r("changeSlope",_)}},Ge=g=>{p=void 0,g.target.releasePointerCapture(g.pointerId),o.setMouseNavEnabled(!0)};return Pe(()=>(document.addEventListener("pointerup",Ge),o.addHandler("open",M),o.addHandler("update-viewport",te),M(),()=>{o.removeHandler("page",M),o.removeHandler("update-viewport",te)})),e.$$set=g=>{"viewer"in g&&n(10,o=g.viewer),"handlePadding"in g&&n(11,a=g.handlePadding),"visible"in g&&n(0,f=g.visible),"initialSlope"in g&&n(12,l=g.initialSlope)},e.$$.update=()=>{e.$$.dirty&2&&n(7,i=8/s)},[f,s,u,_,d,h,m,i,We,Ze,o,a,l]}class De extends x{constructor(t){super(),$(this,t,Ae,Te,Z,{viewer:10,handlePadding:11,visible:0,initialSlope:12})}}const Be=e=>localStorage.setItem("screen-ruler-slope",e.toString()),Le=()=>{const e=localStorage.getItem("screen-ruler-slope");return e?parseFloat(e):0},Xe=e=>e?localStorage.setItem("screen-ruler-visibility","true"):localStorage.removeItem("screen-ruler-visibility"),Ye=()=>localStorage.getItem("screen-ruler-visibility")==="true",Ue=(e,t)=>{let n=(t==null?void 0:t.visible)===void 0?t!=null&&t.persistentVisibility?Ye():!0:t.visible;const i=t!=null&&t.persistentSlope?Le():0,r=new De({target:e.element.querySelector(".openseadragon-canvas"),props:{viewer:e,visible:n,initialSlope:i}});return t!=null&&t.persistentSlope&&r.$on("changeSlope",l=>{const u=l.detail;Be(u)}),{destroy:()=>r.$destroy(),isVisible:()=>n,setVisible:l=>{n=l,r.$set({visible:l}),t!=null&&t.persistentVisibility&&Xe(l)}}};w.init=Ue,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=osd-screenruler.js.map
